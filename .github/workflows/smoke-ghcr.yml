name: Smoke test GHCR image
on: { workflow_dispatch: {} }
permissions: { contents: read, packages: read }
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: docker pull ghcr.io/antegulin/nodegoat:sha-0d46dd7
      - run: docker network create demo
      - run: docker run -d --name mongo --network demo mongo:7
      - run: |
          for i in {1..30}; do
            docker exec mongo mongosh --quiet --eval "db.runCommand({ ping: 1 }).ok" | grep -q 1 && break
            sleep 2
          done
      - run: |
          docker run -d --name app --network demo -p 4000:4000 \
            -e MONGODB_URI="mongodb://mongo:27017/nodegoat" \
            ghcr.io/antegulin/nodegoat:sha-0d46dd7
      - run: |
          for i in {1..30}; do curl -fsS http://localhost:4000/ && exit 0; sleep 2; done
          echo "App did not respond" && exit 1
      - if: always()
        run: docker logs --tail=200 app || true
